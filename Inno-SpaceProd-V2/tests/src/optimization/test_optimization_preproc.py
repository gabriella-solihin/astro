import pandas as pd
import pytest

from pyspark import Row

from tests.src.optimization.mock_containers.raw_data_list_of_reruns import (
    raw_data_list_of_reruns,
)
from tests.src.optimization.mock_containers.raw_data_region_banner_dept_step_one import (
    raw_data_region_banner_dept_step_one,
)
from tests.src.optimization.mock_containers.raw_data_region_banner_dept_step_two import (
    raw_data_region_banner_dept_step_two,
)
from tests.utils.spark_util import spark_tests as spark
from pyspark.sql import DataFrame as SparkDataFrame
from spaceprod.src.optimization.pre_process.helpers_data_ingest import (
    read_elasticity_curves,
    read_location_data,
    read_merged_clusters_df,
    read_product_df,
    read_shelve_space_and_department_mapping_data,
)
from spaceprod.utils.data_helpers import get_temp_paths

from spaceprod.src.optimization.pre_process.udf import (
    generate_udf_pre_proc_region_banner_dept_step_one,
    generate_udf_pre_proc_region_banner_dept_step_two,
    generate_udf_pre_proc_region_banner_dept_store,
)

from spaceprod.src.optimization.pre_process.helpers_udf import (
    generate_region_banner_dept_skeleton,
)


from tests.src.optimization.mock_containers.raw_data_general import (
    mock_raw_data_general,
)


@pytest.fixture(scope="session")
def mock_location() -> SparkDataFrame:
    mock_location = spark.createDataFrame(
        [
            Row(
                RETAIL_OUTLET_LOCATION_SK="28169",
                STORE_NO="9085",
                STORE_PHYSICAL_LOCATION_NO="14727",
                POSTAL_CD="H3K1P2",
                REGION_DESC="Ontario",
                NATIONAL_BANNER_DESC="SOBEYS",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                RETAIL_OUTLET_LOCATION_SK="28166",
                STORE_NO="9276",
                POSTAL_CD="H3K1P2",
                STORE_PHYSICAL_LOCATION_NO="14727",
                REGION_DESC="Ontario",
                NATIONAL_BANNER_DESC="SOBEYS",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                RETAIL_OUTLET_LOCATION_SK="28146",
                STORE_NO="9215",
                POSTAL_CD="H3K1P2",
                STORE_PHYSICAL_LOCATION_NO="10590",
                REGION_DESC="Ontario",
                NATIONAL_BANNER_DESC="SOBEYS",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                RETAIL_OUTLET_LOCATION_SK="28145",
                STORE_NO="9677",
                STORE_PHYSICAL_LOCATION_NO="14750",
                POSTAL_CD="H3K1P2",
                REGION_DESC="Ontario",
                NATIONAL_BANNER_DESC="SOBEYS",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                RETAIL_OUTLET_LOCATION_SK="28143",
                STORE_NO="3866",
                POSTAL_CD="H3K1P2",
                STORE_PHYSICAL_LOCATION_NO="10590",
                REGION_DESC="Ontario",
                NATIONAL_BANNER_DESC="SOBEYS",
                ACTIVE_STATUS_CD="A",
            ),
        ]
    )

    return mock_location


@pytest.fixture(scope="session")
def mock_merged_clusters() -> SparkDataFrame:
    mock_merged_clusters_data = spark.createDataFrame(
        [
            Row(
                REGION="ontario",
                BANNER="SOBEYS",
                BANNER_KEY="1009515",
                STORE_PHYSICAL_LOCATION_NO="11239",
                INTERNAL_CLUSTER="1",
                EXTERNAL_CLUSTER="A",
                MERGED_CLUSTER="1A",
            ),
            Row(
                REGION="ontario",
                BANNER="SOBEYS",
                BANNER_KEY="1015919",
                STORE_PHYSICAL_LOCATION_NO="11429",
                INTERNAL_CLUSTER="2",
                EXTERNAL_CLUSTER="B",
                MERGED_CLUSTER="2B",
            ),
            Row(
                REGION="ontario",
                BANNER="SOBEYS",
                BANNER_KEY="1021822",
                STORE_PHYSICAL_LOCATION_NO="11308",
                INTERNAL_CLUSTER="2",
                EXTERNAL_CLUSTER="B",
                MERGED_CLUSTER="2B",
            ),
            Row(
                REGION="ontario",
                BANNER="SOBEYS",
                BANNER_KEY="1021830",
                STORE_PHYSICAL_LOCATION_NO="13047",
                INTERNAL_CLUSTER="2",
                EXTERNAL_CLUSTER="B",
                MERGED_CLUSTER="2B",
            ),
            Row(
                REGION="ontario",
                BANNER="SOBEYS",
                BANNER_KEY="5000695",
                STORE_PHYSICAL_LOCATION_NO="13025",
                INTERNAL_CLUSTER="2",
                EXTERNAL_CLUSTER="B",
                MERGED_CLUSTER="2B",
            ),
        ]
    )

    return mock_merged_clusters_data


@pytest.fixture(scope="session")
def mock_merged_clusters_external() -> SparkDataFrame:
    mock_merged_clusters_external_data = spark.createDataFrame(
        [
            Row(
                BANNER="FOODLAND",
                REGION="ATLANTIC",
                BANNER_KEY="1009515",
                STORE_PHYSICAL_LOCATION_NO="22144",
                BAN_NAME="Foodland Blackville",
                BAN_NO="9085",
                PARENT_DESC="SOBEYS INC",
                BAN_DESC="Foodland",
                CITY="Blackville",
                LATITUDE="46.72898",
                LONGITUDE="-65.831546",
                TOT_GROSS_AREA="9000",
                INTERNAL_CLUSTER="1",
                EXTERNAL_CLUSTER="A",
                MERGE_CLUSTER="1A",
                TOT_VISITS="158259",
                TOT_UNITS="954969",
                TOT_SALES="3573557.462",
                TOT_PROMO_SALES="2017720.7",
                TOT_PROMO_UNITS="587099",
                SPEND_PER_VISIT="22.58043752",
                UNITS_PER_VISIT="6.034216064",
                PRICE_PER_UNIT="3.742066456",
                PERC_PROMO_UNITS="0.614783307",
                PERC_PROMO_SALES="0.564625229",
                PERC_TOTAL_SALES="1.62E-04",
                PERC_TOTAL_UNITS="1.81E-04",
                PERC_TOTAL_VISITS="2.85E-04",
            ),
            Row(
                BANNER="FOODLAND",
                REGION="ATLANTIC",
                BANNER_KEY="1015919",
                STORE_PHYSICAL_LOCATION_NO="21546",
                BAN_NAME="CO-OP Cheticamp",
                BAN_NO="9276",
                PARENT_DESC="SOBEYS INC",
                BAN_DESC="CO-OP Sobeys Supplied",
                CITY="Cheticamp",
                LATITUDE="46.6234326",
                LONGITUDE="-61.01871663",
                TOT_GROSS_AREA="17000",
                INTERNAL_CLUSTER="1",
                EXTERNAL_CLUSTER="A",
                MERGE_CLUSTER="2B",
                TOT_VISITS="211333",
                TOT_UNITS="2201133",
                TOT_SALES="9238101.038",
                TOT_PROMO_SALES="5646461.117",
                TOT_PROMO_UNITS="1435037",
                SPEND_PER_VISIT="43.7134808",
                UNITS_PER_VISIT="10.41547226",
                PRICE_PER_UNIT="4.196975393",
                PERC_PROMO_UNITS="0.651953789",
                PERC_PROMO_SALES="0.611214479",
                PERC_TOTAL_SALES="4.19E-04",
                PERC_TOTAL_UNITS="4.18E-04",
                PERC_TOTAL_VISITS="3.80E-04",
            ),
            Row(
                BANNER="FOODLAND",
                REGION="ATLANTIC",
                BANNER_KEY="1021822",
                STORE_PHYSICAL_LOCATION_NO="14184",
                BAN_NAME="Foodland Bonavista",
                BAN_NO="9215",
                PARENT_DESC="SOBEYS INC",
                BAN_DESC="Foodland",
                CITY="Bonavista",
                LATITUDE="48.64766316",
                LONGITUDE="-53.10339781",
                TOT_GROSS_AREA="11000",
                INTERNAL_CLUSTER="1",
                EXTERNAL_CLUSTER="A",
                MERGE_CLUSTER="2B",
                TOT_VISITS="216990",
                TOT_UNITS="1681754",
                TOT_SALES="7427368.832",
                TOT_PROMO_SALES="4022614.218",
                TOT_PROMO_UNITS="1055803",
                SPEND_PER_VISIT="34.22908352",
                UNITS_PER_VISIT="7.750375593",
                PRICE_PER_UNIT="4.416441901",
                PERC_PROMO_UNITS="0.627798715",
                PERC_PROMO_SALES="0.541593438",
                PERC_TOTAL_SALES="3.37E-04",
                PERC_TOTAL_UNITS="3.20E-04",
                PERC_TOTAL_VISITS="3.91E-04",
            ),
            Row(
                BANNER="FRESH CO",
                REGION="ONTARIO",
                BANNER_KEY="1021830",
                STORE_PHYSICAL_LOCATION_NO="11231",
                BAN_NAME="FreshCo. NFront Belleville",
                BAN_NO="9677",
                PARENT_DESC="SOBEYS INC",
                BAN_DESC="Freshco.",
                CITY="Belleville",
                LATITUDE="44.185001",
                LONGITUDE="-77.392761",
                TOT_GROSS_AREA="32142",
                INTERNAL_CLUSTER="3",
                EXTERNAL_CLUSTER="B",
                MERGE_CLUSTER="2B",
                TOT_VISITS="427134",
                TOT_UNITS="6391263",
                TOT_SALES="1.90E+07",
                TOT_PROMO_SALES="8049234.271",
                TOT_PROMO_UNITS="2894339",
                SPEND_PER_VISIT="44.55827114",
                UNITS_PER_VISIT="14.96313335",
                PRICE_PER_UNIT="2.97787035",
                PERC_PROMO_UNITS="0.452858692",
                PERC_PROMO_SALES="0.422923768",
                PERC_TOTAL_SALES="8.64E-04",
                PERC_TOTAL_UNITS="0.001214244",
                PERC_TOTAL_VISITS="7.69E-04",
            ),
            Row(
                BANNER="FRESH CO",
                REGION="ONTARIO",
                BANNER_KEY="5000695",
                STORE_PHYSICAL_LOCATION_NO="11442",
                BAN_NAME="FreshCo. Queen & Gladstone",
                BAN_NO="3866",
                PARENT_DESC="SOBEYS INC",
                BAN_DESC="Freshco.",
                CITY="Toronto",
                LATITUDE="43.64312744",
                LONGITUDE="-79.42678833",
                TOT_GROSS_AREA="31182",
                INTERNAL_CLUSTER="2",
                EXTERNAL_CLUSTER="C",
                MERGE_CLUSTER="2B",
                TOT_VISITS="577920",
                TOT_UNITS="6316560",
                TOT_SALES="1.86E+07",
                TOT_PROMO_SALES="6829216.373",
                TOT_PROMO_UNITS="2524723",
                SPEND_PER_VISIT="32.21903218",
                UNITS_PER_VISIT="10.92981728",
                PRICE_PER_UNIT="2.947810688",
                PERC_PROMO_UNITS="0.399699045",
                PERC_PROMO_SALES="0.366767342",
                PERC_TOTAL_SALES="8.45E-04",
                PERC_TOTAL_UNITS="0.001200051",
                PERC_TOTAL_VISITS="0.001040111",
            ),
        ]
    )

    return mock_merged_clusters_external_data


@pytest.fixture(scope="session")
def mock_combined_pog_processed() -> SparkDataFrame:
    mock_combined_pog_processed_data = spark.createDataFrame(
        [
            Row(
                ITEM_NO="314792",
                STORE="9085",
                SECTION_NAME="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                FACINGS="1",
                LENGTH_SECTION_INCHES="270",
                WIDTH=10.26,
                SECTION_MASTER="Frozen Pizza",
            ),
            Row(
                ITEM_NO="314793",
                STORE="9276",
                SECTION_NAME="FROZEN PIZZA 05DR SBY ONT",
                RELEASE_DATE="20SEP2021",
                FACINGS="1",
                LENGTH_SECTION_INCHES="150",
                WIDTH=10.26,
                SECTION_MASTER="Frozen Pizza",
            ),
            Row(
                ITEM_NO="314794",
                STORE="9215",
                SECTION_NAME="FROZEN PIZZA 10DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                FACINGS="1",
                LENGTH_SECTION_INCHES="300",
                WIDTH=10.26,
                SECTION_MASTER="Frozen Pizza",
            ),
            Row(
                ITEM_NO="314795",
                STORE="9677",
                SECTION_NAME="FROZEN PIZZA 06DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                FACINGS="1",
                LENGTH_SECTION_INCHES="180",
                WIDTH=10.26,
                SECTION_MASTER="Frozen Pizza",
            ),
            Row(
                ITEM_NO="314796",
                STORE="3866",
                SECTION_NAME="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                FACINGS="1",
                LENGTH_SECTION_INCHES="270",
                WIDTH=10.26,
                SECTION_MASTER="Frozen Pizza",
            ),
        ]
    )

    return mock_combined_pog_processed_data


@pytest.fixture(scope="session")
def mock_pog_department_mapping_file() -> SparkDataFrame:
    mock_pog_department_mapping_file_data = spark.createDataFrame(
        [
            Row(
                Region="Ontario",
                Banner="SOBEYS",
                SECTION_MASTER="Frozen Pizza",
                PM_LVL2_Tag="Frozen Grocery",
                PM_LVL3_Tag="Frozen Ready Meals",
                PM_LVL4_Mode="Frozen Pizza",
                Department="Centre Store",
                In_Scope="1",
                Sum_of_Item_Count="84",
            ),
            Row(
                Region="Ontario",
                Banner="SOBEYS",
                SECTION_MASTER="Frozen Pizza",
                PM_LVL2_Tag="Frozen Grocery",
                PM_LVL3_Tag="Frozen Ready Meals",
                PM_LVL4_Mode="Frozen Pizza",
                Department="Centre Store",
                In_Scope="1",
                Sum_of_Item_Count="76",
            ),
            Row(
                Region="Ontario",
                Banner="SOBEYS",
                SECTION_MASTER="Frozen Pizza",
                PM_LVL2_Tag="Frozen Grocery",
                PM_LVL3_Tag="Frozen Ready Meals",
                PM_LVL4_Mode="Frozen Pizza",
                Department="Centre Store",
                In_Scope="1",
                Sum_of_Item_Count="84",
            ),
            Row(
                Region="Ontario",
                Banner="IGA",
                SECTION_MASTER="Frozen Pizza",
                PM_LVL2_Tag="Frozen Grocery",
                PM_LVL3_Tag="Frozen Ready Meals",
                PM_LVL4_Mode="Frozen Pizza",
                Department="Centre Store",
                In_Scope="1",
                Sum_of_Item_Count="115",
            ),
            Row(
                Region="Ontario",
                Banner="FRESH CO",
                SECTION_MASTER="Frozen Pizza",
                PM_LVL2_Tag="Frozen Grocery",
                PM_LVL3_Tag="Frozen Ready Meals",
                PM_LVL4_Mode="Frozen Pizza",
                Department="Centre Store",
                In_Scope="1",
                Sum_of_Item_Count="72",
            ),
        ]
    )

    return mock_pog_department_mapping_file_data


@pytest.fixture(scope="session")
def mock_final_elastisity_output_sales() -> SparkDataFrame:
    mock_final_elastisity_output_sales_data = spark.createDataFrame(
        [
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                beta=0.7726404070854187,
                facing_fit_1=0.535553514957428,
                facing_fit_2=0.8488322496414185,
                facing_fit_3=1.071107029914856,
                facing_fit_4=1.2435168027877808,
                facing_fit_5=1.3843858242034912,
                facing_fit_6=1.5034887790679932,
                facing_fit_7=1.6066606044769287,
                facing_fit_8=1.697664499282837,
                facing_fit_9=1.779070258140564,
                facing_fit_10=1.8527108430862427,
                facing_fit_11=1.9199392795562744,
                facing_fit_12=1.9817835092544556,
                facing_fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                beta=2.31135630607605,
                facing_fit_1=1.6021101474761963,
                facing_fit_2=2.5392844676971436,
                facing_fit_3=3.2042202949523926,
                facing_fit_4=3.719984769821167,
                facing_fit_5=4.14139461517334,
                facing_fit_6=4.497692108154297,
                facing_fit_7=4.806330680847168,
                facing_fit_8=5.078568935394287,
                facing_fit_9=5.322094917297363,
                facing_fit_10=5.542390823364258,
                facing_fit_11=5.743505001068115,
                facing_fit_12=5.928512096405029,
                facing_fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                beta=2.463073253631592,
                facing_fit_1=1.7072722911834717,
                facing_fit_2=2.7059624195098877,
                facing_fit_3=3.4145445823669434,
                facing_fit_4=3.964163303375244,
                facing_fit_5=4.413234710693359,
                facing_fit_6=4.792919158935547,
                facing_fit_7=5.121816635131836,
                facing_fit_8=5.411924839019775,
                facing_fit_9=5.671435832977295,
                facing_fit_10=5.906191825866699,
                facing_fit_11=6.120506763458252,
                facing_fit_12=6.317657947540283,
                facing_fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                beta=0.734053373336792,
                facing_fit_1=0.5088070631027222,
                facing_fit_2=0.8064400553703308,
                facing_fit_3=1.0176141262054443,
                facing_fit_4=1.1814134120941162,
                facing_fit_5=1.3152471780776978,
                facing_fit_6=1.4284019470214844,
                facing_fit_7=1.526421070098877,
                facing_fit_8=1.6128801107406616,
                facing_fit_9=1.6902203559875488,
                facing_fit_10=1.7601832151412964,
                facing_fit_11=1.8240541219711304,
                facing_fit_12=1.8828097581863403,
                facing_fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                beta=2.463073253631592,
                facing_fit_1=1.7072722911834717,
                facing_fit_2=2.7059624195098877,
                facing_fit_3=3.4145445823669434,
                facing_fit_4=3.964163303375244,
                facing_fit_5=4.413234710693359,
                facing_fit_6=4.792919158935547,
                facing_fit_7=5.121816635131836,
                facing_fit_8=5.411924839019775,
                facing_fit_9=5.671435832977295,
                facing_fit_10=5.906191825866699,
                facing_fit_11=6.120506763458252,
                facing_fit_12=6.317657947540283,
                facing_fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
            ),
        ]
    )
    return mock_final_elastisity_output_sales_data


@pytest.fixture(scope="session")
def mock_final_elastisity_output_margin() -> SparkDataFrame:
    mock_final_elastisity_output_margin_data = spark.createDataFrame(
        [
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                beta=0.07042841613292694,
                facing_fit_1=0.04881725832819939,
                facing_fit_2=0.07737352699041367,
                facing_fit_3=0.09763451665639877,
                facing_fit_4=0.11335016787052155,
                facing_fit_5=0.12619078159332275,
                facing_fit_6=0.13704738020896912,
                facing_fit_7=0.14645178616046906,
                facing_fit_8=0.15474705398082733,
                facing_fit_9=0.16216742992401123,
                facing_fit_10=0.16887997090816498,
                facing_fit_11=0.17500804364681244,
                facing_fit_12=0.18064533174037933,
                facing_fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                beta=0.5747926831245422,
                facing_fit_1=0.3984159231185913,
                facing_fit_2=0.6314743161201477,
                facing_fit_3=0.7968318462371826,
                facing_fit_4=0.9250931143760681,
                facing_fit_5=1.0298901796340942,
                facing_fit_6=1.1184948682785034,
                facing_fit_7=1.195247769355774,
                facing_fit_8=1.2629486322402954,
                facing_fit_9=1.3235090970993042,
                facing_fit_10=1.3782926797866821,
                facing_fit_11=1.4283061027526855,
                facing_fit_12=1.4743140935897827,
                facing_fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                beta=0.6158000230789185,
                facing_fit_1=0.42684003710746765,
                facing_fit_2=0.6765254735946655,
                facing_fit_3=0.8536800742149353,
                facing_fit_4=0.9910919070243835,
                facing_fit_5=1.1033655405044556,
                facing_fit_6=1.198291540145874,
                facing_fit_7=1.2805200815200806,
                facing_fit_8=1.353050947189331,
                facing_fit_9=1.4179319143295288,
                facing_fit_10=1.4766238927841187,
                facing_fit_11=1.530205488204956,
                facing_fit_12=1.5794957876205444,
                facing_fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                beta=0.07827479392290115,
                facing_fit_1=0.054255951195955276,
                facing_fit_2=0.08599364757537842,
                facing_fit_3=0.10851190239191055,
                facing_fit_4=0.12597841024398804,
                facing_fit_5=0.1402495950460434,
                facing_fit_6=0.15231570601463318,
                facing_fit_7=0.16276785731315613,
                facing_fit_8=0.17198729515075684,
                facing_fit_9=0.18023435771465302,
                facing_fit_10=0.1876947432756424,
                facing_fit_11=0.19450554251670837,
                facing_fit_12=0.20077086985111237,
                facing_fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
            ),
            Row(
                Region="ontario",
                National_Banner_Desc="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                beta=0.6158000230789185,
                facing_fit_1=0.42684003710746765,
                facing_fit_2=0.6765254735946655,
                facing_fit_3=0.8536800742149353,
                facing_fit_4=0.9910919070243835,
                facing_fit_5=1.1033655405044556,
                facing_fit_6=1.198291540145874,
                facing_fit_7=1.2805200815200806,
                facing_fit_8=1.353050947189331,
                facing_fit_9=1.4179319143295288,
                facing_fit_10=1.4766238927841187,
                facing_fit_11=1.530205488204956,
                facing_fit_12=1.5794957876205444,
                facing_fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
            ),
        ]
    )
    return mock_final_elastisity_output_margin_data


@pytest.fixture(scope="session")
def mock_product() -> SparkDataFrame:
    mock_product_data = spark.createDataFrame(
        [
            Row(
                Lvl5_Name="Cake - Cream Goods",
                Lvl4_Name="Made In Store Cake",
                Lvl3_Name="Cakes",
                Lvl2_Name="Bakery",
                Item_Name="La Rocca 1/2 Strawberry Shortc",
                Item_No="314792",
            ),
            Row(
                Lvl5_Name="DMeat FS Salami Slicing Salami",
                Lvl4_Name="Deli Salami",
                Lvl3_Name="Deli Meat Service",
                Lvl2_Name="Deli",
                Item_Name="Comp Salami Sausage",
                Item_No="314793",
            ),
            Row(
                Lvl5_Name="Baking - Cherries",
                Lvl4_Name="Baking Ingredients",
                Lvl3_Name="Baking",
                Lvl2_Name="Grocery Ambient",
                Item_Name="Daltons Green Cherries",
                Item_No="314794",
            ),
            Row(
                Lvl5_Name="DChs Washed Rind Bulk Raclette",
                Lvl4_Name="Wshd Rind BlkDeliChs",
                Lvl3_Name="Deli Cheese Bulk",
                Lvl2_Name="Deli",
                Item_Name="Cheese Swiss Raclette",
                Item_No="1000113",
            ),
            Row(
                Lvl5_Name="ISB Swt Treats Cookies Everyday",
                Lvl4_Name="ISB Swt Trts Cookies",
                Lvl3_Name="Instore Bakery Swt Treats",
                Lvl2_Name="Instore Bakery",
                Item_Name="Choc Chip Cookies Value Pk",
                Item_No="314795",
            ),
        ]
    )

    return mock_product_data


@pytest.fixture(scope="session")
def mock_bay_data_prefix() -> SparkDataFrame:
    mock_bay_data_prefix_data = spark.createDataFrame(
        [
            [
                Row(
                    NATIONAL_BANNER_DESC="SOBEYS",
                    REGION="ontario",
                    SECTION_MASTER="Frozen Handhelds",
                    EXEC_ID="ontario_SOBEYS_FrozenHandhelds",
                    STORE_PHYSICAL_LOCATION_NO="11211",
                    ITEM_NO="413819",
                    ITEM_NAME="DrOetker Ristornt T/Crst PzVeg",
                    Sales=6.28000020980835,
                    Facings="1",
                    E2E_MARGIN_TOTAL=-0.6384810400555674,
                    cannib_id="CANNIB-930",
                    need_state="-1",
                    Item_Count=2.0,
                    MERGED_CLUSTER="1B",
                ),
                Row(
                    NATIONAL_BANNER_DESC="SOBEYS",
                    REGION="ontario",
                    SECTION_MASTER="Frozen Handhelds",
                    EXEC_ID="ontario_SOBEYS_FrozenHandhelds",
                    STORE_PHYSICAL_LOCATION_NO="11211",
                    ITEM_NO="576782",
                    ITEM_NAME="DrOetker Glusep Thin Can  510g",
                    Sales=83.8599967956543,
                    Facings="1",
                    E2E_MARGIN_TOTAL=20.63535798492478,
                    cannib_id="CANNIB-930",
                    need_state="0",
                    Item_Count=14.0,
                    MERGED_CLUSTER="1B",
                ),
                Row(
                    NATIONAL_BANNER_DESC="SOBEYS",
                    REGION="ontario",
                    SECTION_MASTER="Frozen Pizza",
                    EXEC_ID="ontario_SOBEYS_FrozenPizza",
                    STORE_PHYSICAL_LOCATION_NO="11211",
                    ITEM_NO="819649",
                    ITEM_NAME="DrOetker Pizza RiCrust 4Cheese",
                    Sales=5.989999771118164,
                    Facings="1",
                    E2E_MARGIN_TOTAL=1.172282917694476,
                    cannib_id="CANNIB-930",
                    need_state="1",
                    Item_Count=1.0,
                    MERGED_CLUSTER="1B",
                ),
                Row(
                    NATIONAL_BANNER_DESC="SOBEYS",
                    REGION="ontario",
                    SECTION_MASTER="Frozen Pizza",
                    EXEC_ID="ontario_SOBEYS_FrozenPizza",
                    STORE_PHYSICAL_LOCATION_NO="11211",
                    ITEM_NO="900100",
                    ITEM_NAME="SMI Opsite 24632 Dr 5x5in  1ea",
                    Sales=3.990000009536743,
                    Facings="1",
                    E2E_MARGIN_TOTAL=1.318333246310552,
                    cannib_id="CANNIB-930",
                    need_state="-1",
                    Item_Count=1.0,
                    MERGED_CLUSTER="1B",
                ),
                Row(
                    NATIONAL_BANNER_DESC="SOBEYS",
                    REGION="ontario",
                    SECTION_MASTER="Frozen Handhelds",
                    EXEC_ID="ontario_SOBEYS_FrozenHandhelds",
                    STORE_PHYSICAL_LOCATION_NO="11215",
                    ITEM_NO="576782",
                    ITEM_NAME="DrOetker Glusep Thin Can  510g",
                    Sales=53.90999794006348,
                    Facings="1",
                    E2E_MARGIN_TOTAL=13.387525557868386,
                    cannib_id="CANNIB-930",
                    need_state="0",
                    Item_Count=9.0,
                    MERGED_CLUSTER="2B",
                ),
            ]
        ]
    )

    return mock_bay_data_prefix_data


@pytest.fixture(scope="session")
def mock_pdf_shelve_space():
    mock_pdf_shelve_space_data = spark.createDataFrame(
        [
            Row(
                Store_No="3866",
                Item_No="314796",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="3866",
                Item_No="314796",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="3866",
                Item_No="314796",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9085",
                Item_No="314792",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9085",
                Item_No="314792",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9085",
                Item_No="314792",
                Section_Name="FROZEN PIZZA 09DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="270",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9677",
                Item_No="314795",
                Section_Name="FROZEN PIZZA 06DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="180",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9677",
                Item_No="314795",
                Section_Name="FROZEN PIZZA 06DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="180",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9677",
                Item_No="314795",
                Section_Name="FROZEN PIZZA 06DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="180",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9276",
                Item_No="314793",
                Section_Name="FROZEN PIZZA 05DR SBY ONT",
                RELEASE_DATE="20SEP2021",
                Facings="1",
                LENGTH_SECTION_INCHES="150",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9276",
                Item_No="314793",
                Section_Name="FROZEN PIZZA 05DR SBY ONT",
                RELEASE_DATE="20SEP2021",
                Facings="1",
                LENGTH_SECTION_INCHES="150",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9276",
                Item_No="314793",
                Section_Name="FROZEN PIZZA 05DR SBY ONT",
                RELEASE_DATE="20SEP2021",
                Facings="1",
                LENGTH_SECTION_INCHES="150",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9215",
                Item_No="314794",
                Section_Name="FROZEN PIZZA 10DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="300",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9215",
                Item_No="314794",
                Section_Name="FROZEN PIZZA 10DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="300",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
            Row(
                Store_No="9215",
                Item_No="314794",
                Section_Name="FROZEN PIZZA 10DR SBY ONT",
                RELEASE_DATE="16JUL2021",
                Facings="1",
                LENGTH_SECTION_INCHES="300",
                Width=10.26,
                Section_Master="Frozen Pizza",
                Banner="SOBEYS",
                Region_Desc="ontario",
                Department="Centre Store",
            ),
        ]
    )

    return mock_pdf_shelve_space_data


@pytest.fixture(scope="session")
def mock_pdf_elasticity_curves_sales():
    mock_pdf_elasticity_curves_sales_data = spark.createDataFrame(
        [
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.7726404070854187,
                Facing_Fit_1=0.535553514957428,
                Facing_Fit_2=0.8488322496414185,
                Facing_Fit_3=1.071107029914856,
                Facing_Fit_4=1.2435168027877808,
                Facing_Fit_5=1.3843858242034912,
                Facing_Fit_6=1.5034887790679932,
                Facing_Fit_7=1.6066606044769287,
                Facing_Fit_8=1.697664499282837,
                Facing_Fit_9=1.779070258140564,
                Facing_Fit_10=1.8527108430862427,
                Facing_Fit_11=1.9199392795562744,
                Facing_Fit_12=1.9817835092544556,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.7726404070854187,
                Facing_Fit_1=0.535553514957428,
                Facing_Fit_2=0.8488322496414185,
                Facing_Fit_3=1.071107029914856,
                Facing_Fit_4=1.2435168027877808,
                Facing_Fit_5=1.3843858242034912,
                Facing_Fit_6=1.5034887790679932,
                Facing_Fit_7=1.6066606044769287,
                Facing_Fit_8=1.697664499282837,
                Facing_Fit_9=1.779070258140564,
                Facing_Fit_10=1.8527108430862427,
                Facing_Fit_11=1.9199392795562744,
                Facing_Fit_12=1.9817835092544556,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.7726404070854187,
                Facing_Fit_1=0.535553514957428,
                Facing_Fit_2=0.8488322496414185,
                Facing_Fit_3=1.071107029914856,
                Facing_Fit_4=1.2435168027877808,
                Facing_Fit_5=1.3843858242034912,
                Facing_Fit_6=1.5034887790679932,
                Facing_Fit_7=1.6066606044769287,
                Facing_Fit_8=1.697664499282837,
                Facing_Fit_9=1.779070258140564,
                Facing_Fit_10=1.8527108430862427,
                Facing_Fit_11=1.9199392795562744,
                Facing_Fit_12=1.9817835092544556,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=2.31135630607605,
                Facing_Fit_1=1.6021101474761963,
                Facing_Fit_2=2.5392844676971436,
                Facing_Fit_3=3.2042202949523926,
                Facing_Fit_4=3.719984769821167,
                Facing_Fit_5=4.14139461517334,
                Facing_Fit_6=4.497692108154297,
                Facing_Fit_7=4.806330680847168,
                Facing_Fit_8=5.078568935394287,
                Facing_Fit_9=5.322094917297363,
                Facing_Fit_10=5.542390823364258,
                Facing_Fit_11=5.743505001068115,
                Facing_Fit_12=5.928512096405029,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=2.31135630607605,
                Facing_Fit_1=1.6021101474761963,
                Facing_Fit_2=2.5392844676971436,
                Facing_Fit_3=3.2042202949523926,
                Facing_Fit_4=3.719984769821167,
                Facing_Fit_5=4.14139461517334,
                Facing_Fit_6=4.497692108154297,
                Facing_Fit_7=4.806330680847168,
                Facing_Fit_8=5.078568935394287,
                Facing_Fit_9=5.322094917297363,
                Facing_Fit_10=5.542390823364258,
                Facing_Fit_11=5.743505001068115,
                Facing_Fit_12=5.928512096405029,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=2.31135630607605,
                Facing_Fit_1=1.6021101474761963,
                Facing_Fit_2=2.5392844676971436,
                Facing_Fit_3=3.2042202949523926,
                Facing_Fit_4=3.719984769821167,
                Facing_Fit_5=4.14139461517334,
                Facing_Fit_6=4.497692108154297,
                Facing_Fit_7=4.806330680847168,
                Facing_Fit_8=5.078568935394287,
                Facing_Fit_9=5.322094917297363,
                Facing_Fit_10=5.542390823364258,
                Facing_Fit_11=5.743505001068115,
                Facing_Fit_12=5.928512096405029,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.734053373336792,
                Facing_Fit_1=0.5088070631027222,
                Facing_Fit_2=0.8064400553703308,
                Facing_Fit_3=1.0176141262054443,
                Facing_Fit_4=1.1814134120941162,
                Facing_Fit_5=1.3152471780776978,
                Facing_Fit_6=1.4284019470214844,
                Facing_Fit_7=1.526421070098877,
                Facing_Fit_8=1.6128801107406616,
                Facing_Fit_9=1.6902203559875488,
                Facing_Fit_10=1.7601832151412964,
                Facing_Fit_11=1.8240541219711304,
                Facing_Fit_12=1.8828097581863403,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.734053373336792,
                Facing_Fit_1=0.5088070631027222,
                Facing_Fit_2=0.8064400553703308,
                Facing_Fit_3=1.0176141262054443,
                Facing_Fit_4=1.1814134120941162,
                Facing_Fit_5=1.3152471780776978,
                Facing_Fit_6=1.4284019470214844,
                Facing_Fit_7=1.526421070098877,
                Facing_Fit_8=1.6128801107406616,
                Facing_Fit_9=1.6902203559875488,
                Facing_Fit_10=1.7601832151412964,
                Facing_Fit_11=1.8240541219711304,
                Facing_Fit_12=1.8828097581863403,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.734053373336792,
                Facing_Fit_1=0.5088070631027222,
                Facing_Fit_2=0.8064400553703308,
                Facing_Fit_3=1.0176141262054443,
                Facing_Fit_4=1.1814134120941162,
                Facing_Fit_5=1.3152471780776978,
                Facing_Fit_6=1.4284019470214844,
                Facing_Fit_7=1.526421070098877,
                Facing_Fit_8=1.6128801107406616,
                Facing_Fit_9=1.6902203559875488,
                Facing_Fit_10=1.7601832151412964,
                Facing_Fit_11=1.8240541219711304,
                Facing_Fit_12=1.8828097581863403,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=2.463073253631592,
                Facing_Fit_1=1.7072722911834717,
                Facing_Fit_2=2.7059624195098877,
                Facing_Fit_3=3.4145445823669434,
                Facing_Fit_4=3.964163303375244,
                Facing_Fit_5=4.413234710693359,
                Facing_Fit_6=4.792919158935547,
                Facing_Fit_7=5.121816635131836,
                Facing_Fit_8=5.411924839019775,
                Facing_Fit_9=5.671435832977295,
                Facing_Fit_10=5.906191825866699,
                Facing_Fit_11=6.120506763458252,
                Facing_Fit_12=6.317657947540283,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
        ]
    )
    return mock_pdf_elasticity_curves_sales_data


@pytest.fixture(scope="session")
def mock_pdf_elasticity_curves_margin():
    mock_pdf_elasticity_curves_margin_data = spark.createDataFrame(
        [
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.07042841613292694,
                Facing_Fit_1=0.04881725832819939,
                Facing_Fit_2=0.07737352699041367,
                Facing_Fit_3=0.09763451665639877,
                Facing_Fit_4=0.11335016787052155,
                Facing_Fit_5=0.12619078159332275,
                Facing_Fit_6=0.13704738020896912,
                Facing_Fit_7=0.14645178616046906,
                Facing_Fit_8=0.15474705398082733,
                Facing_Fit_9=0.16216742992401123,
                Facing_Fit_10=0.16887997090816498,
                Facing_Fit_11=0.17500804364681244,
                Facing_Fit_12=0.18064533174037933,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.07042841613292694,
                Facing_Fit_1=0.04881725832819939,
                Facing_Fit_2=0.07737352699041367,
                Facing_Fit_3=0.09763451665639877,
                Facing_Fit_4=0.11335016787052155,
                Facing_Fit_5=0.12619078159332275,
                Facing_Fit_6=0.13704738020896912,
                Facing_Fit_7=0.14645178616046906,
                Facing_Fit_8=0.15474705398082733,
                Facing_Fit_9=0.16216742992401123,
                Facing_Fit_10=0.16887997090816498,
                Facing_Fit_11=0.17500804364681244,
                Facing_Fit_12=0.18064533174037933,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314792",
                Item_Name="DrOetker Ristornt T/Crst PzVeg",
                Cannib_Id="CANNIB-930",
                Need_State="-1",
                Cannib_Id_Idx="1",
                Need_State_Idx="1",
                Cluster_Need_State="-1_1B",
                Cluster_Need_State_Idx="1",
                M_Cluster="1B",
                Beta=0.07042841613292694,
                Facing_Fit_1=0.04881725832819939,
                Facing_Fit_2=0.07737352699041367,
                Facing_Fit_3=0.09763451665639877,
                Facing_Fit_4=0.11335016787052155,
                Facing_Fit_5=0.12619078159332275,
                Facing_Fit_6=0.13704738020896912,
                Facing_Fit_7=0.14645178616046906,
                Facing_Fit_8=0.15474705398082733,
                Facing_Fit_9=0.16216742992401123,
                Facing_Fit_10=0.16887997090816498,
                Facing_Fit_11=0.17500804364681244,
                Facing_Fit_12=0.18064533174037933,
                Facing_Fit_0=0.0,
                Margin=-0.09611542522907257,
                Sales=0.9453763961791992,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=0.5747926831245422,
                Facing_Fit_1=0.3984159231185913,
                Facing_Fit_2=0.6314743161201477,
                Facing_Fit_3=0.7968318462371826,
                Facing_Fit_4=0.9250931143760681,
                Facing_Fit_5=1.0298901796340942,
                Facing_Fit_6=1.1184948682785034,
                Facing_Fit_7=1.195247769355774,
                Facing_Fit_8=1.2629486322402954,
                Facing_Fit_9=1.3235090970993042,
                Facing_Fit_10=1.3782926797866821,
                Facing_Fit_11=1.4283061027526855,
                Facing_Fit_12=1.4743140935897827,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=0.5747926831245422,
                Facing_Fit_1=0.3984159231185913,
                Facing_Fit_2=0.6314743161201477,
                Facing_Fit_3=0.7968318462371826,
                Facing_Fit_4=0.9250931143760681,
                Facing_Fit_5=1.0298901796340942,
                Facing_Fit_6=1.1184948682785034,
                Facing_Fit_7=1.195247769355774,
                Facing_Fit_8=1.2629486322402954,
                Facing_Fit_9=1.3235090970993042,
                Facing_Fit_10=1.3782926797866821,
                Facing_Fit_11=1.4283061027526855,
                Facing_Fit_12=1.4743140935897827,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314793",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_1B",
                Cluster_Need_State_Idx="2",
                M_Cluster="1B",
                Beta=0.5747926831245422,
                Facing_Fit_1=0.3984159231185913,
                Facing_Fit_2=0.6314743161201477,
                Facing_Fit_3=0.7968318462371826,
                Facing_Fit_4=0.9250931143760681,
                Facing_Fit_5=1.0298901796340942,
                Facing_Fit_6=1.1184948682785034,
                Facing_Fit_7=1.195247769355774,
                Facing_Fit_8=1.2629486322402954,
                Facing_Fit_9=1.3235090970993042,
                Facing_Fit_10=1.3782926797866821,
                Facing_Fit_11=1.4283061027526855,
                Facing_Fit_12=1.4743140935897827,
                Facing_Fit_0=0.0,
                Margin=13.900300025939941,
                Sales=55.79376220703125,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314794",
                Item_Name="DrOetker Glusep Thin Can  510g",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=16.9149227142334,
                Sales=68.07988739013672,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.07827479392290115,
                Facing_Fit_1=0.054255951195955276,
                Facing_Fit_2=0.08599364757537842,
                Facing_Fit_3=0.10851190239191055,
                Facing_Fit_4=0.12597841024398804,
                Facing_Fit_5=0.1402495950460434,
                Facing_Fit_6=0.15231570601463318,
                Facing_Fit_7=0.16276785731315613,
                Facing_Fit_8=0.17198729515075684,
                Facing_Fit_9=0.18023435771465302,
                Facing_Fit_10=0.1876947432756424,
                Facing_Fit_11=0.19450554251670837,
                Facing_Fit_12=0.20077086985111237,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.07827479392290115,
                Facing_Fit_1=0.054255951195955276,
                Facing_Fit_2=0.08599364757537842,
                Facing_Fit_3=0.10851190239191055,
                Facing_Fit_4=0.12597841024398804,
                Facing_Fit_5=0.1402495950460434,
                Facing_Fit_6=0.15231570601463318,
                Facing_Fit_7=0.16276785731315613,
                Facing_Fit_8=0.17198729515075684,
                Facing_Fit_9=0.18023435771465302,
                Facing_Fit_10=0.1876947432756424,
                Facing_Fit_11=0.19450554251670837,
                Facing_Fit_12=0.20077086985111237,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314795",
                Item_Name="DrOetker Ristornt Pollo Pizza",
                Cannib_Id="CANNIB-930",
                Need_State="1",
                Cannib_Id_Idx="1",
                Need_State_Idx="3",
                Cluster_Need_State="1_2B",
                Cluster_Need_State_Idx="4",
                M_Cluster="2B",
                Beta=0.07827479392290115,
                Facing_Fit_1=0.054255951195955276,
                Facing_Fit_2=0.08599364757537842,
                Facing_Fit_3=0.10851190239191055,
                Facing_Fit_4=0.12597841024398804,
                Facing_Fit_5=0.1402495950460434,
                Facing_Fit_6=0.15231570601463318,
                Facing_Fit_7=0.16276785731315613,
                Facing_Fit_8=0.17198729515075684,
                Facing_Fit_9=0.18023435771465302,
                Facing_Fit_10=0.1876947432756424,
                Facing_Fit_11=0.19450554251670837,
                Facing_Fit_12=0.20077086985111237,
                Facing_Fit_0=0.0,
                Margin=0.015969423577189445,
                Sales=0.848279595375061,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
            Row(
                Region_Desc="ontario",
                Banner="SOBEYS",
                Section_Master="Frozen Pizza",
                Item_No="314796",
                Item_Name="DrOetKer Giusep Thin Crst Spin",
                Cannib_Id="CANNIB-930",
                Need_State="0",
                Cannib_Id_Idx="1",
                Need_State_Idx="2",
                Cluster_Need_State="0_2B",
                Cluster_Need_State_Idx="3",
                M_Cluster="2B",
                Beta=0.6158000230789185,
                Facing_Fit_1=0.42684003710746765,
                Facing_Fit_2=0.6765254735946655,
                Facing_Fit_3=0.8536800742149353,
                Facing_Fit_4=0.9910919070243835,
                Facing_Fit_5=1.1033655405044556,
                Facing_Fit_6=1.198291540145874,
                Facing_Fit_7=1.2805200815200806,
                Facing_Fit_8=1.353050947189331,
                Facing_Fit_9=1.4179319143295288,
                Facing_Fit_10=1.4766238927841187,
                Facing_Fit_11=1.530205488204956,
                Facing_Fit_12=1.5794957876205444,
                Facing_Fit_0=0.0,
                Margin=0.5619652271270752,
                Sales=2.7051610946655273,
                Department="Centre Store",
            ),
        ]
    )
    return mock_pdf_elasticity_curves_margin_data


@pytest.fixture(scope="session")
def mock_pdf_merged_clusters():
    mock_pdf_merged_clusters_data = spark.createDataFrame(
        [
            Row(
                Banner="FOODLAND",
                Region_Desc="atlantic",
                Banner_Key="1009515",
                Store_Physical_Location_No="22144",
                Ban_Name="Foodland Blackville",
                Ban_No="9085",
                Parent_Desc="SOBEYS INC",
                Ban_Desc="Foodland",
                City="Blackville",
                Latitude="46.72898",
                Longitude="-65.831546",
                Tot_Gross_Area="9000",
                Internal_Cluster="1",
                External_Cluster="A",
                Merge_Cluster="1A",
                Tot_Visits="158259",
                Tot_Units="954969",
                Tot_Sales="3573557.462",
                Tot_Promo_Sales="2017720.7",
                Tot_Promo_Units="587099",
                Spend_Per_Visit="22.58043752",
                Units_Per_Visit="6.034216064",
                Price_Per_Unit="3.742066456",
                Perc_Promo_Units="0.614783307",
                Perc_Promo_Sales="0.564625229",
                Perc_Total_Sales="1.62E-04",
                Perc_Total_Units="1.81E-04",
                Perc_Total_Visits="2.85E-04",
            ),
            Row(
                Banner="FOODLAND",
                Region_Desc="atlantic",
                Banner_Key="1015919",
                Store_Physical_Location_No="21546",
                Ban_Name="CO-OP Cheticamp",
                Ban_No="9276",
                Parent_Desc="SOBEYS INC",
                Ban_Desc="CO-OP Sobeys Supplied",
                City="Cheticamp",
                Latitude="46.6234326",
                Longitude="-61.01871663",
                Tot_Gross_Area="17000",
                Internal_Cluster="1",
                External_Cluster="A",
                Merge_Cluster="2B",
                Tot_Visits="211333",
                Tot_Units="2201133",
                Tot_Sales="9238101.038",
                Tot_Promo_Sales="5646461.117",
                Tot_Promo_Units="1435037",
                Spend_Per_Visit="43.7134808",
                Units_Per_Visit="10.41547226",
                Price_Per_Unit="4.196975393",
                Perc_Promo_Units="0.651953789",
                Perc_Promo_Sales="0.611214479",
                Perc_Total_Sales="4.19E-04",
                Perc_Total_Units="4.18E-04",
                Perc_Total_Visits="3.80E-04",
            ),
            Row(
                Banner="FOODLAND",
                Region_Desc="atlantic",
                Banner_Key="1021822",
                Store_Physical_Location_No="14184",
                Ban_Name="Foodland Bonavista",
                Ban_No="9215",
                Parent_Desc="SOBEYS INC",
                Ban_Desc="Foodland",
                City="Bonavista",
                Latitude="48.64766316",
                Longitude="-53.10339781",
                Tot_Gross_Area="11000",
                Internal_Cluster="1",
                External_Cluster="A",
                Merge_Cluster="2B",
                Tot_Visits="216990",
                Tot_Units="1681754",
                Tot_Sales="7427368.832",
                Tot_Promo_Sales="4022614.218",
                Tot_Promo_Units="1055803",
                Spend_Per_Visit="34.22908352",
                Units_Per_Visit="7.750375593",
                Price_Per_Unit="4.416441901",
                Perc_Promo_Units="0.627798715",
                Perc_Promo_Sales="0.541593438",
                Perc_Total_Sales="3.37E-04",
                Perc_Total_Units="3.20E-04",
                Perc_Total_Visits="3.91E-04",
            ),
            Row(
                Banner="FRESH CO",
                Region_Desc="ontario",
                Banner_Key="1021830",
                Store_Physical_Location_No="11231",
                Ban_Name="FreshCo. NFront Belleville",
                Ban_No="9677",
                Parent_Desc="SOBEYS INC",
                Ban_Desc="Freshco.",
                City="Belleville",
                Latitude="44.185001",
                Longitude="-77.392761",
                Tot_Gross_Area="32142",
                Internal_Cluster="3",
                External_Cluster="B",
                Merge_Cluster="2B",
                Tot_Visits="427134",
                Tot_Units="6391263",
                Tot_Sales="1.90E+07",
                Tot_Promo_Sales="8049234.271",
                Tot_Promo_Units="2894339",
                Spend_Per_Visit="44.55827114",
                Units_Per_Visit="14.96313335",
                Price_Per_Unit="2.97787035",
                Perc_Promo_Units="0.452858692",
                Perc_Promo_Sales="0.422923768",
                Perc_Total_Sales="8.64E-04",
                Perc_Total_Units="0.001214244",
                Perc_Total_Visits="7.69E-04",
            ),
            Row(
                Banner="FRESH CO",
                Region_Desc="ontario",
                Banner_Key="5000695",
                Store_Physical_Location_No="11442",
                Ban_Name="FreshCo. Queen & Gladstone",
                Ban_No="3866",
                Parent_Desc="SOBEYS INC",
                Ban_Desc="Freshco.",
                City="Toronto",
                Latitude="43.64312744",
                Longitude="-79.42678833",
                Tot_Gross_Area="31182",
                Internal_Cluster="2",
                External_Cluster="C",
                Merge_Cluster="2B",
                Tot_Visits="577920",
                Tot_Units="6316560",
                Tot_Sales="1.86E+07",
                Tot_Promo_Sales="6829216.373",
                Tot_Promo_Units="2524723",
                Spend_Per_Visit="32.21903218",
                Units_Per_Visit="10.92981728",
                Price_Per_Unit="2.947810688",
                Perc_Promo_Units="0.399699045",
                Perc_Promo_Sales="0.366767342",
                Perc_Total_Sales="8.45E-04",
                Perc_Total_Units="0.001200051",
                Perc_Total_Visits="0.001040111",
            ),
        ]
    )
    return mock_pdf_merged_clusters_data


@pytest.fixture(scope="session")
def mock_pdf_location():
    mock_pdf_location_data = spark.createDataFrame(
        [
            Row(
                Retail_Outlet_Location_Sk="28143",
                Store_Physical_Location_No="H3K1P2",
                Banner="SOBEYS",
                Store_No="3866",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                Retail_Outlet_Location_Sk="28166",
                Store_Physical_Location_No="H3K1P2",
                Banner="SOBEYS",
                Store_No="9276",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                Retail_Outlet_Location_Sk="28145",
                Store_Physical_Location_No="14750",
                Banner="SOBEYS",
                Store_No="9677",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                Retail_Outlet_Location_Sk="28169",
                Store_Physical_Location_No="14727",
                Banner="SOBEYS",
                Store_No="9085",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                Retail_Outlet_Location_Sk="28146",
                Store_Physical_Location_No="H3K1P2",
                Banner="SOBEYS",
                Store_No="9215",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
            Row(
                Retail_Outlet_Location_Sk="26978",
                Store_Physical_Location_No="11429",
                Banner="SOBEYS",
                Store_No="4761",
                Region_Desc="ontario",
                ACTIVE_STATUS_CD="A",
            ),
        ]
    )
    return mock_pdf_location_data


def test_read_location_data(mock_location: SparkDataFrame):
    regions = ["quebec", "ontario", "atlantic", "west"]
    banners = ["SOBEYS", "FOODLAND", "IGA", "SAFEWAY", "FRESH CO", "THRIFTY FOODS"]
    global_exclusion_list = [
        "4714",
        "4731",
        "701",
        "867",
        "937",
        "4741",
        "4723",
        "4743",
        "933",
        "934",
        "695",
        "819",
        "693",
        "17066",
    ]
    store_replace = ["17066"]
    store_replace_conf = ("7497", "4761")

    pdf_location, df_location = read_location_data(
        df_location=mock_location,
        regions=regions,
        banners=banners,
        global_exclusion_list=global_exclusion_list,
        store_replace=store_replace,
        store_replace_conf=store_replace_conf,
    )

    # checking the record count
    msg = f"count is not matching"
    assert len(pdf_location) == 6, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_location.columns) == {
        "Banner",
        "Region_Desc",
        "Retail_Outlet_Location_Sk",
        "Store_No",
        "Store_Physical_Location_No",
        "ACTIVE_STATUS_CD",
    }, msg


def test_read_merged_clusters_df(
    mock_pdf_location: SparkDataFrame,
    mock_merged_clusters: SparkDataFrame,
    mock_merged_clusters_external: SparkDataFrame,
):
    # read merged cluster file
    pdf_merged_clusters = read_merged_clusters_df(
        df_merged_clusters=mock_merged_clusters,
        df_merged_clusters_external=mock_merged_clusters_external,
        pdf_location=mock_pdf_location.toPandas(),
        use_merged_clusters_post_review=True,
    )

    pdf_merged_clusters = spark.createDataFrame(pdf_merged_clusters)

    # checking the record count
    msg = f"count is not matching"
    assert pdf_merged_clusters.count() == 5, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_merged_clusters.columns) == {
        "Ban_Desc",
        "Ban_Name",
        "Ban_No",
        "Banner",
        "Banner_Key",
        "City",
        "External_Cluster",
        "Internal_Cluster",
        "Latitude",
        "Longitude",
        "Merge_Cluster",
        "Parent_Desc",
        "Perc_Promo_Sales",
        "Perc_Promo_Units",
        "Perc_Total_Sales",
        "Perc_Total_Units",
        "Perc_Total_Visits",
        "Price_Per_Unit",
        "Region_Desc",
        "Spend_Per_Visit",
        "Store_Physical_Location_No",
        "Tot_Gross_Area",
        "Tot_Promo_Sales",
        "Tot_Promo_Units",
        "Tot_Sales",
        "Tot_Units",
        "Tot_Visits",
        "Units_Per_Visit",
    }, msg


def test_read_shelve_space_and_department_mapping_data(
    mock_pdf_location: SparkDataFrame,
    mock_combined_pog_processed: SparkDataFrame,
    mock_pog_department_mapping_file: SparkDataFrame,
):
    regions = ["quebec", "ontario", "atlantic", "west"]
    banners = ["SOBEYS", "FOODLAND", "IGA", "SAFEWAY", "FRESH CO", "THRIFTY FOODS"]
    depts = ["Centre Store"]

    # read plannogram information
    (
        pdf_shelve_space,
        pdf_pog_department_mapping,
    ) = read_shelve_space_and_department_mapping_data(
        pdf_location=mock_pdf_location.toPandas(),
        df_pog_input_file=mock_combined_pog_processed,
        df_pog_department_mapping_file=mock_pog_department_mapping_file,
        regions=regions,
        banners=banners,
        depts=depts,
    )
    pdf_shelve_space = spark.createDataFrame(pdf_shelve_space)
    # checking the record count
    msg = f"count is not matching"
    assert pdf_shelve_space.count() == 15, msg

    pdf_pog_department_mapping = spark.createDataFrame(pdf_pog_department_mapping)
    # checking the record count
    msg = f"count is not matching"
    assert pdf_pog_department_mapping.count() == 5, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_shelve_space.columns) == {
        "Banner",
        "Department",
        "Facings",
        "Item_No",
        "LENGTH_SECTION_INCHES",
        "RELEASE_DATE",
        "Region_Desc",
        "Section_Master",
        "Section_Name",
        "Store_No",
        "Width",
    }, msg
    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_pog_department_mapping.columns) == {
        "Banner",
        "Department",
        "In_Scope",
        "PM_LVL2_Tag",
        "PM_LVL3_Tag",
        "PM_LVL4_Mode",
        "Region_Desc",
        "Section_Master",
        "Sum_of_Item_Count",
    }, msg


def test_read_elasticity_curves(
    mock_final_elastisity_output_sales: SparkDataFrame,
    mock_final_elastisity_output_margin: SparkDataFrame,
    mock_pdf_location: SparkDataFrame,
    mock_combined_pog_processed: SparkDataFrame,
    mock_pog_department_mapping_file: SparkDataFrame,
):
    regions = ["quebec", "ontario", "atlantic", "west"]
    banners = ["SOBEYS", "FOODLAND", "IGA", "SAFEWAY", "FRESH CO", "THRIFTY FOODS"]
    depts = ["Centre Store"]

    # read plannogram information
    (
        pdf_shelve_space,
        pdf_pog_department_mapping,
    ) = read_shelve_space_and_department_mapping_data(
        pdf_location=mock_pdf_location.toPandas(),
        df_pog_input_file=mock_combined_pog_processed,
        df_pog_department_mapping_file=mock_pog_department_mapping_file,
        regions=regions,
        banners=banners,
        depts=depts,
    )
    # read both margin and sales elasticity curves
    (
        pdf_elasticity_curves_sales,
        pdf_elasticity_curves_margin,
    ) = read_elasticity_curves(
        df_elasticity_curves_sales=mock_final_elastisity_output_sales,
        df_elasticity_curves_margin=mock_final_elastisity_output_margin,
        regions=regions,
        banners=banners,
        depts=depts,
        POG_department_mapping=pdf_pog_department_mapping,
    )

    pdf_elasticity_curves_sales = spark.createDataFrame(pdf_elasticity_curves_sales)
    # checking the record count
    msg = f"count is not matching"
    assert pdf_elasticity_curves_sales.count() == 15, msg

    pdf_elasticity_curves_margin = spark.createDataFrame(pdf_elasticity_curves_margin)
    # checking the record count
    msg = f"count is not matching"
    assert pdf_elasticity_curves_margin.count() == 15, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_elasticity_curves_sales.columns) == {
        "Banner",
        "Beta",
        "Cannib_Id",
        "Cannib_Id_Idx",
        "Cluster_Need_State",
        "Cluster_Need_State_Idx",
        "Department",
        "Facing_Fit_0",
        "Facing_Fit_1",
        "Facing_Fit_10",
        "Facing_Fit_11",
        "Facing_Fit_12",
        "Facing_Fit_2",
        "Facing_Fit_3",
        "Facing_Fit_4",
        "Facing_Fit_5",
        "Facing_Fit_6",
        "Facing_Fit_7",
        "Facing_Fit_8",
        "Facing_Fit_9",
        "Item_Name",
        "Item_No",
        "M_Cluster",
        "Margin",
        "Need_State",
        "Need_State_Idx",
        "Region_Desc",
        "Sales",
        "Section_Master",
    }, msg
    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_elasticity_curves_margin.columns) == {
        "Banner",
        "Beta",
        "Cannib_Id",
        "Cannib_Id_Idx",
        "Cluster_Need_State",
        "Cluster_Need_State_Idx",
        "Department",
        "Facing_Fit_0",
        "Facing_Fit_1",
        "Facing_Fit_10",
        "Facing_Fit_11",
        "Facing_Fit_12",
        "Facing_Fit_2",
        "Facing_Fit_3",
        "Facing_Fit_4",
        "Facing_Fit_5",
        "Facing_Fit_6",
        "Facing_Fit_7",
        "Facing_Fit_8",
        "Facing_Fit_9",
        "Item_Name",
        "Item_No",
        "M_Cluster",
        "Margin",
        "Need_State",
        "Need_State_Idx",
        "Region_Desc",
        "Sales",
        "Section_Master",
    }, msg


def test_read_product_df(mock_product: SparkDataFrame):
    pdf_product = read_product_df(mock_product)
    pdf_product = spark.createDataFrame(pdf_product)
    # checking the record count
    msg = f"count is not matching"
    assert pdf_product.count() == 5, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(pdf_product.columns) == {
        "Lvl5_Name",
        "Lvl4_Name",
        "Lvl3_Name",
        "Lvl2_Name",
        "Item_Name",
        "Item_No",
    }, msg


def test_generate_region_banner_dept_skeleton(
    mock_pdf_location: SparkDataFrame,
    mock_bay_data_prefix: SparkDataFrame,
    mock_pdf_shelve_space: SparkDataFrame,
    mock_product: SparkDataFrame,
    mock_pdf_elasticity_curves_margin: SparkDataFrame,
    mock_pdf_elasticity_curves_sales: SparkDataFrame,
    mock_merged_clusters: SparkDataFrame,
):
    path = get_temp_paths(name="test_udf_post_proc_per_reg_ban_dept")[0]

    mock_raw_data_general.save(path)

    df_skeleton = generate_region_banner_dept_skeleton(
        pdf_elasticity_curves_sales=mock_raw_data_general.elasticity_curves_sales_df,
        rerun=False,
    )

    msg = f"count is not matching"
    assert df_skeleton.count() == 1, msg

    # checking the schema
    msg = f"schema is not matching"
    assert set(df_skeleton.columns) == {
        "REGION",
        "BANNER",
        "DEPT",
    }, msg


def test_generate_udf_pre_proc_region_banner_dept_step_one():
    path = get_temp_paths(name="test_udf_post_proc_per_reg_ban_dept")[0]

    mock_raw_data_general.save(path)

    udf_to_test = generate_udf_pre_proc_region_banner_dept_step_one(
        path_opt_data_containers=path,
        rerun=False,
    )

    # mock PDF data to be used in UDF
    pdf = pd.DataFrame(
        [
            {
                "REGION": "ontario",
                "BANNER": "SOBEYS",
                "DEPT": "Frozen",
            }
        ]
    )

    # call the udf underlying function
    # NOTE: we are not calling the udf using the standard Spark way
    # we are just calling the underlying function

    pdf_res = udf_to_test.func(pdf)

    # some basic assertions
    col_new = "PATH_PRE_PROC_RAW_DATA_STEP_ONE"
    cols = list(pdf.columns) + [col_new]
    assert set(pdf_res.columns) == set(cols), "wrong cols"

    assert len(pdf_res) == 1

    val = pdf_res[col_new][0]
    assert val == "RawDataRegionBannerDeptStepOne/ontario/SOBEYS/Frozen.pkl"


def test_generate_udf_pre_proc_region_banner_dept_step_two():

    path = get_temp_paths(name="test_udf_post_proc_per_reg_ban_dept")[0]
    raw_data_region_banner_dept_step_one.save(path)
    raw_data_list_of_reruns.save(path)

    section_master_excluded = [
        "Frozen Natural Combo",
        "Frozen Natural Breads Gluten Free",
        "Frozen Natural Entrees Pizza",
        "Frznaturalcombo",
        "Frozennaturalcombo",
        "Frznatbreadsgf",
        "Frznatentreespizza",
        "Frznatentreespizz",
        "Frozen Bread GF",
        "Frozen Natural",
    ]

    mock_legal_section_break_dict = {
        "use_legal_section_break_dict": False,
        "Frozen": {
            "legal_break_width": 30,
            "extra_space_in_legal_breaks_max": 2,
            "extra_space_in_legal_breaks_min": 2,
            "min_breaks_per_section": 1,
        },
        "Dairy": {
            "legal_break_width": 48,
            "extra_space_in_legal_breaks_max": 2,
            "extra_space_in_legal_breaks_min": 2,
            "min_breaks_per_section": 1,
        },
        "All_other": {
            "legal_break_width": 12,
            "extra_space_in_legal_breaks_max": 8,
            "extra_space_in_legal_breaks_min": 8,
            "min_breaks_per_section": 4,
        },
    }

    udf_to_test = generate_udf_pre_proc_region_banner_dept_step_two(
        path_opt_data_containers=path,
        dependent_var="Sales",
        max_facings=13,
        use_macro_section_length=False,
        enable_margin_reruns=True,
        rerun=False,
        section_master_excluded=section_master_excluded,
        section_length_lower_deviation=0.98,
        section_length_upper_deviation=1.02,
        difference_of_facings_to_allocate_from_max_in_POG=0,
        legal_section_break_increments={"Frozen": 30, "All_other": 48},
        minimum_shelves_assumption=0,
        possible_number_of_shelves_min=3,
        possible_number_of_shelves_max=8,
        overwrite_at_min_shelve_increment=False,
        enable_localized_space=True,
        overwrite_local_space_percentage=0.02,
        filter_for_test_negotiations=False,
        facing_percentile=0.98,
        hold_items_constant_from_file=False,
        run_on_theoretic_space=True,
        legal_section_break_dict=mock_legal_section_break_dict,
    )

    # mock PDF data to be used in UDF
    pdf = pd.DataFrame(
        [
            {
                "REGION": "ontario",
                "BANNER": "SOBEYS",
                "DEPT": "Frozen",
            }
        ]
    )

    # call the udf underlying function
    # NOTE: we are not calling the udf using the standard Spark way
    # we are just calling the underlying function

    pdf_res = udf_to_test.func(pdf)

    # some basic assertions
    cols_new = ["PATH_PRE_PROC_RAW_DATA_STEP_TWO", "STORE_LIST"]
    cols = list(pdf.columns) + cols_new
    assert set(pdf_res.columns) == set(cols), "wrong cols"

    assert len(pdf_res) == 1

    val = pdf_res["PATH_PRE_PROC_RAW_DATA_STEP_TWO"][0]
    assert val == "RawDataRegionBannerDeptStepTwo/ontario/SOBEYS/Frozen.pkl"


def test_generate_udf_pre_proc_region_banner_dept_store():

    path = get_temp_paths(name="test_udf_post_proc_per_reg_ban_dept")[0]
    raw_data_region_banner_dept_step_two.save(path)

    udf_to_test = generate_udf_pre_proc_region_banner_dept_store(
        path_opt_data_containers=path,
        rerun=False,
    )

    # mock PDF data to be used in UDF
    pdf = pd.DataFrame(
        [
            {
                "REGION": "ontario",
                "BANNER": "SOBEYS",
                "DEPT": "Frozen",
                "STORE": "11215",
            }
        ]
    )

    # call the udf underlying function
    # NOTE: we are not calling the udf using the standard Spark way
    # we are just calling the underlying function

    pdf_res = udf_to_test.func(pdf)

    # some basic assertions
    cols_new = ["PATH_PRE_PROC_RAW_DATA_STORE"]
    cols = list(pdf.columns) + cols_new
    assert set(pdf_res.columns) == set(cols), "wrong cols"

    assert len(pdf_res) == 1

    val = pdf_res["PATH_PRE_PROC_RAW_DATA_STORE"][0]
    assert val == "RawDataRegionBannerDeptStore/ontario/SOBEYS/Frozen/11215.pkl"
